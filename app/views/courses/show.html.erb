<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.20/css/jquery.dataTables.css">
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.js"></script>


<body class='view4'>
  <div class='container profile-container' id="classroom" data_channel_subscribe="room" data-room-active="<%= @course.has_enough_projects%>" data-room-id="<%= @course.id %>" data-room-voting="<%= @course.voting%>">
  
    <% if !flash[:alert].nil?%>
      <div class="alert alert-danger">
        <strong> Group creation had the following errors: </strong>
        <% flash[:alert].each do |error| %>
          <li> <%= error %> </li>
        <% end %>
      </div>
    <% end %>

    <% if !flash[:success].nil?%>
      <div class="alert alert-success">
        <%= flash[:success] %>
      </div>
    <%end %>


    <% if @course.errors.any? %>
      <div id="alert alert-danger">
        <p><%= pluralize(@course.errors.count, "error") %> prohibited this course from being updating:</p>
        <ul>
          <% @course.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %> 
      <div class='row profile-row'>
        <div class='col profile-column'>
          <p>
            <strong>Course Name:</strong>
            <%= @course.name %>
          </p>

          <p>
            <strong>Pin:</strong>
            <%= @course.pin %>
          </p>

          <p>
            <strong>Professor:</strong>
            <% professor = @course.professor %>
            <%= professor.firstname + ' '+ professor.lastname  %>
          </p>
        </div>

        <% if current_user_type == "professor" && get_professor_id(@course) == current_user.id%>
          <% create_groups_path = @course.id.to_s+ "/create_groups" %>
          <div class='col course-button-column'>
            <%= button_to 'Create Random Groups', {:controller => "courses", :action => "create_groups", :algo => "random"}, :class => "btn btn-outline-primary addButton", :method=>:post%>
            <br>
            
            <div id='header' class="header">
            <div>
              <p class="warning"> <strong> Group Creation using preferences is disabled due to: </strong> </p>
            </div>
            
            
              <% if !get_message(@course).empty? %>
                <img src="/assets/yellow-alert.png" height="22" width="22">
              <% end %>
              <p class="warning"> <%= get_message(@course) %> </p>
              <div class="warnings">
                <img src="/assets/yellow-alert.png" height="22" width="22">
                <p class="warning">  Voting still in progress </p>
              </div>
              <p></p>
            </div>
            

            <div class = disabled>
              <%= button_to 'Create Groups Based on Project Preference', {:controller => "courses", :action => "create_groups", :algo => "project_only"},  :disabled => true, :class => "btn btn-outline-primary addButton", :method=>:post%>
              <br>
              <button disabled class="btn btn-outline-primary addButton" data-toggle="modal" data-target="#professor-preference-form">
                Create Groups Based on All Preference
              </button>
            </div>

            <div class = enabled >
              <%= button_to 'Create Groups Based on Project Preference', {:controller => "courses", :action => "create_groups", :algo => "project_only"},  :disabled => false, :class => "btn btn-outline-primary addButton", :method=>:post%>
              <br>        
              <button class="btn btn-outline-primary addButton" data-toggle="modal" data-target="#professor-preference-form">
                Create Groups Based on All Preference
              </button>
            </div>
              
          </div>

            <div class="modal fade" id="professor-preference-form" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
              <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                  <div class="modal-header border-bottom-0">
                    <h5 class="modal-title" id="exampleModalLabel">Create Your Preference for: <span><%= @course.name %></span></h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>
                
                  <div class="modal-body">
                      <%= form_with(url: create_groups_course_path, local: true) do |f| %>
                        <%= hidden_field_tag :algo, 'holistic'%>
                        <div class="alert alert-danger d-none">Please review the problems below:</div>
                       
                        <label class="modal-label"><%= f.label 'How important are students\' preferences on project choices?'%> </label>
                        <%= f.collection_radio_buttons :projectWeight, [[1,1],[2,2],[3,3],[4,4],[5,5]], :first, :last, { item_wrapper_tag: false },{:style=>"
                        margin-left: 24px; margin-right:5px;"}%>
                        <br> <p> unimportant &emsp; &emsp; &emsp; &emsp; &emsp; very important </p>
                        <hr size="10">
                        <label class="modal-label"><%= f.label 'Do you want each team to have various level of coding proficiencies?' %></label>
                        <%= f.collection_radio_buttons :codingWeight, [[1,1],[2,2],[3,3],[4,4],[5,5]], :first, :last, { item_wrapper_tag: false },{:style=>"
                        margin-left: 24px; margin-right:5px"}%>
                        <p> not diverse &emsp; &emsp; &emsp; &emsp; &emsp; as diverse as possible </p><hr size="10">
                        <label class="modal-label"><%= f.label 'How important are students\' preferences on their partner choice?'%></label>
                        <%= f.collection_radio_buttons :partnerWeight, [[1,1],[2,2],[3,3],[4,4],[5,5]], :first, :last, { item_wrapper_tag: false },{:style=>"
                        margin-left: 24px; margin-right:5px"}%>
                        <p> unimportant &emsp; &emsp; &emsp; &emsp; &emsp; very important </p><hr size="10">
                        <label class="modal-label"><%= f.label 'Should team members have more than 2 hours/week avaiable meeting-time?'%></label>
                        <%= f.collection_radio_buttons :scheduleWeight, [[1,1],[2,2],[3,3],[4,4],[5,5]], :first, :last, { item_wrapper_tag: false },{:style=>"
                        margin-left: 24px; margin-right:5px"}%> <p> unimportant &emsp; &emsp; &emsp; &emsp; &emsp; very important </p>
                        <div class="modal-footer border-top-0 d-flex justify-content-center">
                          <div class='modal-button'>
                            <%= f.submit("Submit and Create Group", class: "btn btn-primary createButton") %>
                            <button class="btn btn-outline-primary addButton" type="reset">Reset</button>
                          </div>
                        </div>
                      <%end%>
                  </div>
                </div>
              </div>
            </div>


        <% elsif current_user_type == "student" %>
          <div class='col course-button-column-stu'>
            <%if @course.voting==false then %>
              <%if !Preference.find_by(student_id:current_user.id).nil?%>
                <img src="/assets/green_check.jpg" height="22" width="22">
                <p class ="warning"> Your preference has been recorded</p>
                <p></p>
              <%end%>

              <%= link_to new_preference_path(course: @course) do %>
                <button class="btn btn-outline-primary addButton btn-lg"></i> Create Preference</button>
              <% end %>
            <%else%>
              <img src="/assets/yellow-alert.png" height="32" width="32"> 
              <p class ="warning"> Can not create preferences until voting has ended </p>
              <br> <br>
            <%end%>
          </div>
        <% end %>
      </div>

      <hr/>
      
      <div class='row' id='course-info-box'>
        <div class='col' id='course-info-col'>
          <ul class="nav nav-tabs" id="course-nav">
            <li class="nav-item">
              <a href="#projects" class="nav-link tab-projects active" data-toggle="tab" >Projects</a>
            </li>
            <li class="nav-item">
              <a href="#students" class="nav-link tab-students" data-toggle="tab" >Students</a>
            </li>
            
            <li class="nav-item">
              <a href="#groups" class="nav-link tab-groups" data-toggle="tab" >Groups</a>
            </li>
          </ul>

          <div class="tab-content">

            <div class="tab-pane fade show active" id="projects">
              <% if current_user_type == "professor" && get_professor_id(@course) == current_user.id%>
                <br>
                <div id = "toggle-container">
                  <% if @course.voting==true %>
                  <p class="status" id="status">Current Process: Voting</p>
                  <button class="btn btn-primary btn-lg" id="toggle-button"> End Voting and Allow Preferences</button>
                  <%else%>
                  <p class="status" id="status">Current Process: Preference Filling</p>
                  <button class="btn btn-primary btn-lg" id="toggle-button"> Resume Voting</button>
                  <%end%>

                </div>
                <%= tag.div id: :boards, data:{groups: @course.groups.to_json, course: @course.to_json}%>
              <% else %>    
                <%= tag.div id: :stuboards, data:{groups: @course.groups.to_json,course:@course.to_json, student: Student.find(current_user.id).to_json, taking: Taking.find_by(student_id:current_user.id, course_id:@course.id).to_json}%>              
              <%end%>
            </div>

            <div class="tab-pane fade " id="students">
              <div class="container projects-box">
                <%= render 'students' %>
              </div>
            </div>

            <div class="tab-pane fade" id="groups">
              <div class="container projects-box">   
                <%= render 'groups' %>
              </div>
            </div>
         
          </div> 
        </div>
              
      </div>

  </div>
</body>

<script>

document.addEventListener("turbolinks:load", function(){
  var voting = $('#classroom').attr('data-room-voting')
  var active = $('#classroom').attr('data-room-active')
  console.log(`active ${active}`)
  console.log(voting)
  if (active == "true" && voting == "false") {
    console.log(`hiding header`)
    $(".header").hide()
    $(".disabled").hide()
    $(".enabled").show()
  } else {
    console.log(`showing header`)
    $(".header").show()
    $(".disabled").show()
    $(".enabled").hide()
  }
  if(voting=="true"){
    $(".warnings").show()
  }else{
    $(".warnings").hide()
  }
  $("#toggle-button").on('click', function(event){
    $("#toggle-button").attr("disabled","disabled");
    console.log(window.store.state.course.id)
    console.log(`active2: `)
    console.log(active)
    var course_id = window.store.state.course.id
    var prev_status = window.store.state.course.voting
    var data = new FormData
    data.append("course[voting]", !window.store.state.course.voting)
    data.append("course[course_id]", course_id)
    Rails.ajax({
      url: `/courses/${course_id}/toggle_voting`,
      type: "PATCH",
      data: data,
      dataType: "json",
      success: (data) => {  
        $("#toggle-button").removeAttr("disabled");
        console.log(`current status ${window.store.state.course.voting}`)
        console.log(`previous status ${prev_status}`)
        console.log(`active3: `)
        console.log(active)
        if (active == "true" && window.store.state.course.voting == false){
          $(".header").hide()
          console.log(`hiding header  deep`)
          $(".disabled").hide()
          $(".enabled").show()
        } else {
          $(".header").show()
          console.log(`showing header`)
          $(".disabled").show()
          $(".enabled").hide()
        }
        if(window.store.state.course.voting==false){
          $("#status").text('Current Process: Preference Filling')
          $("#toggle-button").text('Resume Voting')
          $(".warnings").hide()
        }else{
          $("#status").text('Current Process: Voting')
          $("#toggle-button").text( 'End Voting and Allow Preferences')
          $(".warnings").show()
        }
      }
    })
    
  })
})


</script>